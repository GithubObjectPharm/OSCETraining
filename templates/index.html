<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmacyPrep AI Patient Simulator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --bg1: #ffffff;
      --bg2: #f4f4f4;
      --glass: rgba(200, 200, 200, .25);
      --glass-strong: rgba(255, 255, 255, .6);
      --border: rgba(0, 0, 0, .15);
      --text: #000;
      --muted: #333;
      --btn-grad: linear-gradient(135deg, #111, #444);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; zoom: 0.96; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(120deg, var(--bg1) 0%, var(--bg2) 100%);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header { text-align: center; margin: 38px 16px 8px; }
    header h1 { margin: 0 0 6px; font-size: clamp(1.6rem, 2.4vw, 2.2rem); font-weight: 700; color: #000; }
    header p { margin: 0; color: var(--muted); font-size: .98rem; }

    main {
      width: min(96%, 980px);
      margin: 18px auto 28px;
      background: var(--glass);
      backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, .12);
      padding: clamp(16px, 2vw, 28px);
    }

    .controls { display: grid; grid-template-columns: 1fr 160px; gap: 14px; align-items: stretch; }


        
    .upload {
      border: 2px dashed rgba(0, 0, 0, .3);
      border-radius: 14px;
      padding: 16px 18px;
      background: rgba(255, 255, 255, .6);
      text-align: center;
      cursor: pointer;
      transition: .25s ease;
      user-select: none;
      color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .upload:hover { background: rgba(255, 255, 255, .9); border-color: rgba(0, 0, 0, .6); }
    .upload small { display: block; color: #555; margin-top: 2px; }
    input[type="file"] { display: none !important; }

    .btn {
      background: var(--btn-grad);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0, 0, 0, .25);
      transition: .2s transform ease;
      white-space: nowrap;
      height: 100%;
      font-size: 1rem;
    }
    .btn:hover { transform: translateY(-1.5px); }


    
      #resultsBtn {
      background: var(--btn-grad);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0, 0, 0, .25);
      transition: .2s transform ease;
      white-space: nowrap;
    }
    #resultsBtn:hover { transform: translateY(-1.5px); }


    /* ---------- Disabled State Enhancements ---------- */
    #micBtn:disabled,
    .btn:disabled,
    #sendBtn:disabled {
      opacity: 0.55 !important;
      cursor: not-allowed !important;
      pointer-events: auto !important; /* allow hover to show not-allowed cursor */
    }
    #modeToggleBtn {
  height: 100%;
}


    #micBtn:disabled:hover,
    .btn:disabled:hover,
    #sendBtn:disabled:hover {
      opacity: 0.55 !important;
    }

    .status { margin-top: 10px; color: #000; min-height: 20px; }

    /* Session Button */
    .mic-bar { margin-top: 0; margin-bottom: 0; text-align: center; }

      #micBtn {
    width: 100%;
    height: 86px;
    background: linear-gradient(90deg, #000, #333);
    color: #fff;
    font-weight: 700;
    font-size: 1.15rem;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    box-shadow: 0 6px 22px rgba(0, 0, 0, .25);
    transition: all 0.25s ease;
    margin-top: 12px;
  }

  /* Listening / Active */
  #micBtn.active {
    background: linear-gradient(90deg, #ff1744, #ff9100);
    animation: pulse 1.2s infinite;
  }

  /* Speaking */
  #micBtn.speaking {
    background: linear-gradient(90deg, #ff8a00, #ff1744);
  }

  /* Disabled ‚Äî keep full color, but no hover or clicks */
  #micBtn:disabled {
    cursor: not-allowed;
    pointer-events: none;
    filter: brightness(0.9);
  }

  /* Pulse effect */
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
    70% { box-shadow: 0 0 0 14px rgba(255, 0, 0, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
  }


    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
      70% { box-shadow: 0 0 0 14px rgba(255, 0, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    }

    .chat {
      margin-top: 12px; background: var(--glass-strong);
      border: 1px solid var(--border); border-radius: 18px;
      height: 460px; overflow: hidden;
      display: flex; flex-direction: column;
    }

    .messages { padding: 16px; overflow-y: auto; flex: 1 1 auto; scroll-behavior: smooth; }
    .msg { display: flex; margin: 10px 0; }
    .msg.user { justify-content: flex-end; }
    .msg.ai { justify-content: flex-start; }

    .bubble {
      max-width: min(76%, 560px); padding: 10px 14px;
      border-radius: 14px; line-height: 1.45;
      background: rgba(0, 0, 0, .9); color: #fff;
      box-shadow: 0 3px 12px rgba(0, 0, 0, .18);
      white-space: pre-wrap; word-wrap: break-word;
      font-size: 1rem;
    }

    .msg.user .bubble {
      background: #f2f2f2; color: #000;
      box-shadow: 0 3px 12px rgba(0, 0, 0, .15);
    }

    .input-row { display: flex; gap: 10px; padding: 12px; border-top: 1px solid var(--border); background: rgba(255, 255, 255, .8); }
    #userInput { flex: 1; border: none; outline: none; border-radius: 12px; padding: 12px 14px; font-size: 1rem; color: #000; background: #fff; }
    #sendBtn { padding: 12px 18px; }

    footer { text-align: center; color: #444; font-size: .92rem; margin: 8px 16px 26px; }
  </style>
</head>
<body>

  <header>
    <h1>PharmacyPrep AI Patient Simulator</h1>
    <p>Practice patient interviewing and assessment in real time.</p>
  </header>

  <main>
<div class="controls" style="grid-template-columns: 160px 1fr 160px; align-items:center;">
  
  <!-- LEFT BUTTON -->
  <button class="btn" id="modeToggleBtn">Default Cases</button>

  <!-- CENTER COLUMN WRAPPER -->
  <div id="centerContainer" style="width:100%;">

    <!-- UPLOAD BOX (default) -->
    <label class="upload" id="uploadBox" for="caseFile">
      <strong>Upload a Case Scenario File</strong>
      <small>(PDF, TXT, or DOCX)</small>
    </label>
<div id="dropdownContainer" style="display:none; width:100%; display:flex; flex-direction:column; gap:10px;">

  <!-- CHAPTER DROPDOWN -->
  <select id="caseCategory" style="padding:12px; border-radius:10px; width:100%;">
      <option disabled selected>Select Category</option>
      <!-- Dynamic chapters inserted by JS -->
  </select>

  <!-- CASE FILE DROPDOWN -->
  <select id="caseList" style="padding:12px; border-radius:10px; width:100%;">
      <option disabled selected>Select Case</option>
      <!-- Dynamic files inserted by JS -->
  </select>

</div>

  </div>

  <!-- RIGHT BUTTON -->
  <button class="btn" id="resetBtn">New Case</button>

  <input id="caseFile" type="file" accept=".pdf,.txt,.docx">
</div>


    <div id="status" class="status"></div>

    <div class="mic-bar">
      <button id="micBtn">üéôÔ∏è Start Pharmacy Session</button>
    </div>

    <section class="chat">
      <div id="messages" class="messages"></div>
      <div class="input-row">
        <button id="resultsBtn" class="btn" style="width: 100%; height: 52px; font-size: 1rem; font-weight: 700;">
          View Results
        </button>
      </div>
    </section>
  </main>

  <footer>¬© 2025 PharmacyPrep | AI-Driven OSCE Training Platform</footer>

<script>

  
const fileInput   = document.getElementById('caseFile');
const statusEl    = document.getElementById('status');
const messages    = document.getElementById('messages');
const resetBtn    = document.getElementById('resetBtn');
const micBtn      = document.getElementById('micBtn');
const resultsBtn  = document.getElementById('resultsBtn');

let recognition;
let sessionActive = false;
let isSpeaking = false;
let fileUploaded = false;
let locked = false;
let transcriptHTML = ''; // store transcript for toggling back
let caseResults = null; // cache results for this uploaded case



// --- Initial Setup ---
statusEl.textContent = 'üìÑ Please upload a file to begin.';
micBtn.disabled = true;
resultsBtn.disabled = true;

// --- Utility ---
function scrollToBottom() { messages.scrollTop = messages.scrollHeight; }
function addBubble(sender, text) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + sender;
  wrap.innerHTML = `<div class="bubble">${text}</div>`;
  messages.appendChild(wrap);
  scrollToBottom();
}

function disableSessionControls() {
  micBtn.disabled = true;
  resultsBtn.disabled = true;
}
function enableSessionControls() {
  micBtn.disabled = false;
  resultsBtn.disabled = false;
}

const modeBtn = document.getElementById("modeToggleBtn");
const uploadBox = document.getElementById("uploadBox");
const dropdownContainer = document.getElementById("dropdownContainer");

let useDefaultCases = true;

modeBtn.addEventListener("click", () => {
  useDefaultCases = !useDefaultCases;

  if (useDefaultCases) {
    modeBtn.textContent = "Manual Upload";

    // Hide upload box, show dropdowns
    uploadBox.style.display = "none";
    dropdownContainer.style.display = "flex";

    statusEl.textContent = "üìö Default case mode activated. Select a category.";

  } else {
    modeBtn.textContent = "Default Cases";

    // Show upload box, hide dropdowns
    uploadBox.style.display = "flex";
    dropdownContainer.style.display = "none";

    statusEl.textContent = "üìÑ Please upload a file to begin.";
  }
});



/* --------- Upload Case ---------- */
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) {
    statusEl.textContent = 'üìÑ Please upload a file to begin.';
    return;
  }

  statusEl.textContent = 'üß† Uploading and reading case‚Ä¶';
  const fd = new FormData();
  fd.append('file', file);

  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    const data = await res.json();

if (data.error) {
  statusEl.textContent = '‚ùå ' + data.error;
  return;
}


statusEl.textContent = '‚úÖ Case ready. The AI has assumed the patient role.';
fileUploaded = true;
enableSessionControls();

// Show Case Scenario clearly
// Show Case Summary clearly
if (data.case_summary) {
  const formatted = data.case_summary
    .replace(/^Case Summary:/i, "<b>Case Summary:</b> ")
    .replace(/^Case Scenario:/i, "<b>Case Summary:</b> ");
  addBubble('ai', formatted);
} else {
  addBubble('ai', '<b>Case Summary:</b> A patient has come to the pharmacy seeking advice.');
}
  } catch {
    statusEl.textContent = '‚ùå Upload failed.';
  }
});

/* ---------- TTS ---------- */
function playVoice(text) {
  if (isSpeaking) return;
  isSpeaking = true;
  fetch('/tts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  })
    .then(r => r.json())
    .then(d => {
      if (!d.audio) { isSpeaking = false; locked = false; return; }
      const audio = new Audio(d.audio);

      micBtn.classList.remove('active');
      micBtn.classList.add('speaking');
      micBtn.textContent = 'üéôÔ∏è Speaking...';
      micBtn.style.background = 'linear-gradient(90deg, #ff8a00, #ff1744)';
      audio.play();

      audio.onended = () => {
        isSpeaking = false;
        locked = false;
        micBtn.classList.remove('speaking');
        micBtn.classList.add('active');
        micBtn.textContent = 'üéß Listening...';
        micBtn.style.background = 'linear-gradient(90deg, #ff1744, #ff9100)';

        if (sessionActive && recognition) recognition.start();
      };
    })
    .catch(() => { isSpeaking = false; locked = false; });
}
useDefaultCases = true;
modeBtn.textContent = "Manual Upload";
uploadBox.style.display = "none";
dropdownContainer.style.display = "flex";
statusEl.textContent = "üìö Default case mode activated. Select a category.";

/* ---------- Ask ---------- */
async function sendQuestion(text) {
  if (!fileUploaded || locked) return;
  const question = text?.trim();
  if (!question) return;

  locked = true;
  addBubble('user', question);

  try {
    const res = await fetch('/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });
    const data = await res.json();

    if (data.error) {
      addBubble('ai', '(Error) ' + data.error);
      locked = false;
      return;
    }

    addBubble('ai', data.answer);
    playVoice(data.answer);
  } catch {
    addBubble('ai', '(Network error)');
    locked = false;
  }
}

/* ---------- Recognition ---------- */
function startPharmacySession() {
  if (!fileUploaded) return;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Speech recognition not supported');
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.continuous = true;


  recognition.onstart = () => {
    micBtn.classList.add('active');
    micBtn.textContent = 'üéß Listening...';
    micBtn.style.background = 'linear-gradient(90deg, #ff1744, #ff9100)';
  };

let buffer = "";
let silenceTimer = null;

recognition.onresult = (e) => {
  if (locked) return;

  let result = e.results[e.results.length - 1];

  // Only accept FINAL speech segments
  if (!result.isFinal) return;

  let transcript = result[0].transcript.trim();
  buffer += " " + transcript;

  clearTimeout(silenceTimer);

  silenceTimer = setTimeout(() => {
    const finalText = buffer.trim();
    if (finalText.length > 0) {
      sendQuestion(finalText);
    }
    buffer = "";
  }, 1200);
};



  recognition.onend = () => {
    if (sessionActive && !isSpeaking) recognition.start();
  };

  recognition.onerror = () => {
    if (!sessionActive) stopPharmacySession();
  };

  recognition.start();
  micBtn.classList.add('active');
  micBtn.textContent = 'üéß Listening...';
  micBtn.style.background = 'linear-gradient(90deg, #ff1744, #ff9100)';
}

/* ---------- Stop ---------- */
function stopPharmacySession() {
  sessionActive = false;
  locked = false;
  if (recognition) recognition.stop();
  micBtn.classList.remove('active', 'speaking');
  micBtn.textContent = 'üéôÔ∏è Start Pharmacy Session';
  micBtn.style.background = 'linear-gradient(90deg, #000, #333)';
}

/* ---------- Toggle ---------- */
micBtn.addEventListener('click', () => {
  if (!fileUploaded) return;
  sessionActive = !sessionActive;
  if (sessionActive) startPharmacySession();
  else stopPharmacySession();
});

/* ---------- Results ---------- */
resultsBtn.addEventListener('click', async () => {
  if (!fileUploaded) return;

  // If we already have cached results, show them immediately
  if (caseResults) {
    renderResults(caseResults);
    return;
  }

  transcriptHTML = messages.innerHTML;
  messages.innerHTML = '';
  messages.style.background = 'var(--glass-strong)';
  addBubble('ai', 'üìä Generating performance analysis...');

  try {
    const res = await fetch('/results');
    const data = await res.json();
    if (data.error) {
      addBubble('ai', '(Error) ' + data.error);
      return;
    }

    // ‚úÖ cache once per case
    caseResults = data;
    renderResults(data);

  } catch {
    addBubble('ai', '(Network error while fetching results)');
  }
});


function renderBar(label, percent) {
  return `
    <div style="margin-bottom:10px;">
      <div style="font-weight:600;margin-bottom:4px;">${label}
        <span style="float:right;">${percent}%</span>
      </div>
      <div style="width:100%;background:#eee;border-radius:6px;overflow:hidden;height:10px;">
        <div style="width:${percent}%;height:100%;background:#4aa3a3;border-radius:6px;"></div>
      </div>
    </div>
  `;
}


// helper function for bars
function renderBar(label, percent) {
  return `
    <div style="margin-bottom:10px;">
      <div style="font-weight:600;margin-bottom:4px;">${label}
        <span style="float:right;">${percent}%</span>
      </div>
      <div style="width:100%;background:#eee;border-radius:6px;overflow:hidden;height:10px;">
        <div style="width:${percent}%;height:100%;background:#4aa3a3;border-radius:6px;"></div>
      </div>
    </div>
  `;
}

function renderResults(data) {
  const html = `
    <div style="display:flex;justify-content:space-between;gap:32px;flex-wrap:wrap;margin-top:8px;position:relative;">
<button id="backBtn"
  style="position:absolute;top:-18px;left:-8px;
  background:linear-gradient(135deg,#111,#444);
  color:#fff;border:none;border-radius:10px;
  padding:10px 18px;font-weight:700;font-size:1rem;
  cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.25);
  transition:transform .2s ease;">
  ‚Üê Back
</button>

      <div style="flex:1;min-width:280px;">
        <div style="margin-bottom:8px;font-weight:600;">Strengths</div>
        <ul style="list-style:disc;padding-left:20px;margin:0 0 14px 0;font-size:1rem;">
          ${data.good.map(f => `<li>${f}</li>`).join('')}
        </ul>
        <div style="margin-bottom:8px;font-weight:600;">Areas for Improvement</div>
        <ul style="list-style:disc;padding-left:20px;margin:0;font-size:1rem;">
          ${data.improvement.map(f => `<li>${f}</li>`).join('')}
        </ul>
      </div>
      <div style="flex:1;min-width:260px;">
        <h3 style="margin-top:20px;">Interaction Analysis</h3>
        ${renderBar('Listening', data.listening)}
        ${renderBar('Empathy', data.empathy)}
        ${renderBar('Communication', data.communication)}
        ${renderBar('Problem-Solving', data.problem_solving)}
      </div>
    </div>
  `;
  messages.innerHTML = html;

  document.getElementById('backBtn').addEventListener('click', () => {
    messages.innerHTML = transcriptHTML;
    scrollToBottom();
  });
}



/* ---------- Reset Case ---------- */
resetBtn.addEventListener('click', async () => {
  stopPharmacySession();
  await fetch('/reset-case', { method: 'POST' });
  messages.innerHTML = '';
  messages.style.background = 'var(--glass-strong)';
  fileInput.value = '';
  fileUploaded = false;
  disableSessionControls();
  statusEl.textContent = 'üìÑ Please upload a file to begin.';
  addBubble('ai', 'üÜï New session started. Upload a case to begin.');
});
async function loadChapters() {
    const res = await fetch("/list-chapters");
    const data = await res.json();

    const categoryDD = document.getElementById("caseCategory");
    const caseDD = document.getElementById("caseList");

    // Clear dropdowns
    categoryDD.innerHTML = `<option disabled selected>Select Category</option>`;
    caseDD.innerHTML = `<option disabled selected>Select Case</option>`;

    // Populate Chapter Dropdown
    Object.keys(data).forEach(chapter => {
        const opt = document.createElement("option");
        opt.value = chapter;
        opt.textContent = chapter;
        categoryDD.appendChild(opt);
    });

    // When category is selected ‚Üí populate case list
    categoryDD.addEventListener("change", () => {
        const chapter = categoryDD.value;
        const files = data[chapter];

        caseDD.innerHTML = `<option disabled selected>Select Case</option>`;

        files.forEach(file => {
            const opt = document.createElement("option");
            opt.value = file;
            opt.textContent = file;
            caseDD.appendChild(opt);
        });
    });
}

loadChapters();
document.getElementById("caseList").addEventListener("change", async () => {
    const chapter = document.getElementById("caseCategory").value;
    const file = document.getElementById("caseList").value;

    if (!chapter || !file) return;

    statusEl.textContent = "üìò Loading case...";

    const res = await fetch("/load-default-case", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chapter, file })
    });

    const data = await res.json();

    if (data.error) {
        addBubble("ai", "‚ùå " + data.error);
        return;
    }

    // Show Case Summary like manual upload does
    const summaryText = data.case_summary
        .replace(/^Case Summary:/i, "<b>Case Summary:</b> ");

    addBubble("ai", summaryText);

    fileUploaded = true;
    enableSessionControls();

    statusEl.textContent = "‚úÖ Case loaded. AI is now the patient.";
});

/* ---------- Welcome ---------- */
messages.style.background = 'var(--glass-strong)';
addBubble('ai', 'Case Scenario: The patient presents for medication counseling.');
if (data.initial_greeting) {
  addBubble('ai', data.initial_greeting);  // show in chat
  playVoice(data.initial_greeting);        // speak it
}

</script>
</body>
</html>
